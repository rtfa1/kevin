# 3.2. Agent Config & Context (`internal/agent`)

**Goal**: Implement the logic to prepare an Agent for execution. This involves injecting context (via `text/template`) and setting up the environment.

## 1. References & Context
*   **PRD**: [Agent Configuration](../PRD.md#33-agent-orchestration)
*   **Libraries**:
    *   `text/template`: For substituting variables in commands/prompts.
*   **Best Practices**:
    *   **Templates**: Parse once, execute multiple times. Use `text/template` (not HTML) for CLI args.
    *   **Environment**: Host Env > Config `EnvPass` > Internal Defaults.

## 2. Detailed Steps

### A. Context Struct (`internal/agent/context.go`)
Define the data available to templates.

```go
type ExecutionContext struct {
    TaskID     string
    TaskTitle  string
    TaskStatus string
    TaskPath   string // Absolute path to the MD file
    ProjectDir string // Root of the project
}
```

### B. Template Parsing (`internal/agent/template.go`)
Helper to render strings.

```go
func Render(tmpl string, ctx ExecutionContext) (string, error) {
    t, err := template.New("cmd").Parse(tmpl)
    if err != nil { return "", err }
    
    var buf bytes.Buffer
    if err := t.Execute(&buf, ctx); err != nil { return "", err }
    
    return buf.String(), nil
}
```

### C. Environment Merging (`internal/agent/env.go`)
Logic to build the final `[]string` for the executor.

```go
func BuildEnv(cfg core.AgentConfig) []string {
    // 1. Start with current process env
    envMap := toMap(os.Environ())
    
    // 2. Filter/Add based on EnvPass
    // Ideally, we might want to ONLY pass listed vars for security, 
    // or allow all and add extras. 
    // PRD says: "pass passthrough env vars". 
    // Let's implement an explicit allow-list strategy OR valid merge.
    
    finalEnv := []string{}
    for _, key := range cfg.EnvPass {
        if val, ok := envMap[key]; ok {
            finalEnv = append(finalEnv, key+"="+val)
        }
    }
    
    // 3. Add internal vars
    finalEnv = append(finalEnv, "KEVIN_TASK_ID="+...)
    
    return finalEnv
}
```

### D. Agent Preparation
Combine everything into a `Prepare` method.

```go
func Prepare(agent core.AgentConfig, task core.Task, projectDir string) ([]string, []string, error) {
    ctx := ExecutionContext{...}
    
    // 1. Render Command Arguments
    cmd := make([]string, len(agent.Command))
    for i, arg := range agent.Command {
        val, err := Render(arg, ctx)
        if err != nil { return nil, nil, err }
        cmd[i] = val
    }
    
    // 2. Render System Prompt (if any)
    // ...
    
    // 3. Build Env
    env := BuildEnv(agent)
    
    return cmd, env, nil
}
```

## 3. Success Criteria
- [ ] `ExecutionContext` struct defined.
- [ ] `Render` function handles basic keys (`{{.TaskPath}}`).
- [ ] `BuildEnv` correctly extracts requested variables from the host.
- [ ] `Prepare` returns a fully interpolated command slice ready for the Executor.
