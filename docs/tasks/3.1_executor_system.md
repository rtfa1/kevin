# 3.1. Executor System (`internal/executor`)

**Goal**: Implement the `Executor` interface and two concrete implementations: `LocalExecutor` (host shell) and `DockerExecutor` (containerized).

## 1. References & Context
*   **PRD**: [Executor Architecture](../PRD.md#33-agent-orchestration)
*   **Libraries**:
    *   [docker/client](https://github.com/moby/moby/client): Docker SDK for Go.
*   **Best Practices**:
    *   **Context**: Always use `exec.CommandContext` to allow cancellation/timeout.
    *   **Isolation**: Docker Bind Mounts (`HostPath:ContainerPath`) to give agents access to the repo.

## 2. Detailed Steps

### A. Interface Definition (`internal/executor/interface.go`)
Define a unified interface.

```go
package executor

import (
    "context"
    "io"
)

type Executor interface {
    // Run executes a command and streams output.
    // workDir: The directory the agent should start in (on host or in container).
    // env: "KEY=VALUE" strings.
    Run(ctx context.Context, command []string, env []string, workDir string) error
}
```

### B. Local Executor (`internal/executor/local.go`)
Wraps `os/exec`.

```go
type LocalExecutor struct{}

func (e *LocalExecutor) Run(ctx context.Context, cmd []string, env []string, workDir string) error {
    c := exec.CommandContext(ctx, cmd[0], cmd[1:]...)
    c.Dir = workDir
    c.Env = append(os.Environ(), env...)
    
    // Wire stdio to parent process for now (or a pipe if capturing)
    c.Stdout = os.Stdout
    c.Stderr = os.Stderr
    
    return c.Run()
}
```

### C. Docker Executor (`internal/executor/docker.go`)
Wraps the Docker SDK.

1.  **Pull Image**: Check if image exists, pull if not (optional / user responsibility).
2.  **Create Container**:
    *   **Image**: From Config.
    *   **WorkingDir**: `/workspace`.
    *   **Cmd**: `cmd`.
    *   **Env**: `env`.
    *   **HostConfig**: `Mounts`.
        *   `Type: bind`
        *   `Source: workDir` (Host path)
        *   `Target: /workspace`
3.  **Start Container**.
4.  **Attach/Logs**: Stream logs to Stdout/Stderr.
5.  **Wait**: Block until exit code.

```go
// Simplified snippet
resp, err := cli.ContainerCreate(ctx, &container.Config{
    Image: image,
    Cmd:   cmd,
    Env:   env,
    WorkingDir: "/workspace",
}, &container.HostConfig{
    Mounts: []mount.Mount{
        {
            Type:   mount.TypeBind,
            Source: workDir,
            Target: "/workspace",
        },
    },
}, nil, nil, "")
```

## 3. Success Criteria
- [ ] `Executor` interface defined.
- [ ] `LocalExecutor` runs `ls -la` successfully.
- [ ] `DockerExecutor` runs `alpine:latest echo hello` successfully.
- [ ] Context cancellation stops the running process/container.
