# 2.2. Interaction Logic (`internal/tui`)

**Goal**: Implement robust keyboard navigation and action handling using `bubbles/key` and `tea.ExecProcess`.

## 1. References & Context
*   **PRD**: [TUI Actions](../PRD.md#31-the-kanban-board-tui)
*   **Libraries**:
    *   [charmbracelet/bubbles/key](https://github.com/charmbracelet/bubbles): For KeyMap definition.
*   **Patterns**:
    *   **Action bubbling**: Child components (Columns) handle internal navigation; Parent (Board) handles global actions.
    *   **`tea.ExecProcess`**: Used to suspend TUI and open `$EDITOR`.

## 2. Detailed Steps

### A. KeyMap Definition (`internal/tui/keys.go`)
Define all available keys in a struct for self-documenting help.

```go
package tui

import "github.com/charmbracelet/bubbles/key"

type KeyMap struct {
    Up    key.Binding
    Down  key.Binding
    Left  key.Binding
    Right key.Binding
    Enter key.Binding
    New   key.Binding
    Move  key.Binding
    Quit  key.Binding
}

func DefaultKeyMap() KeyMap {
    return KeyMap{
        Up:    key.NewBinding(key.WithKeys("k", "up"), key.WithHelp("k", "up")),
        Down:  key.NewBinding(key.WithKeys("j", "down"), key.WithHelp("j", "down")),
        Left:  key.NewBinding(key.WithKeys("h", "left"), key.WithHelp("h", "left")),
        Right: key.NewBinding(key.WithKeys("l", "right"), key.WithHelp("l", "right")),
        Enter: key.NewBinding(key.WithKeys("enter"), key.WithHelp("enter", "edit")),
        New:   key.NewBinding(key.WithKeys("n"), key.WithHelp("n", "new task")),
        Move:  key.NewBinding(key.WithKeys("H", "L"), key.WithHelp("H/L", "move status")),
        Quit:  key.NewBinding(key.WithKeys("q", "ctrl+c"), key.WithHelp("q", "quit")),
    }
}
```

### B. Opening Editor (`internal/tui/update.go`)
Handling the `Enter` key to open the editor.

```go
func (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    switch msg := msg.(type) {
    case tea.KeyMsg:
        switch {
        case key.Matches(msg, m.keys.Enter):
            // 1. Get selected task file path
            path := m.SelectedTask().FilePath
            // 2. Create editor command
            editor := os.Getenv("EDITOR")
            if editor == "" { editor = "vim" }
            c := exec.Command(editor, path)
            // 3. Suspend TUI and run
            return m, tea.ExecProcess(c, func(err error) tea.Msg {
                if err != nil { return ErrMsg(err) }
                return EditorFinishedMsg{}
            })
        }
    }
    return m, nil
}
```

### C. Status Movement (`H` / `L`)
Logic to move a task between columns.
1.  Identify current status.
2.  Determine next/prev status.
3.  Update `task.Status` field in memory.
4.  Call `m.store.Update(task)` to write to disk.

## 3. Success Criteria
- [ ] `keys.go` defines all bindings with Help text.
- [ ] pressing `?` (optional) or `ctrl+h` shows KeyMap help.
- [ ] Navigation `h/j/k/l` works smoothly.
- [ ] Pressing `enter` opens file in `vim` (or default editor) and resumes TUI on exit.
- [ ] Pressing `H` or `L` moves task visualy (optimistic) and persists to disk.
