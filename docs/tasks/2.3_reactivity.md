# 2.3. Reactivity (The Loop)

**Goal**: Bridge the `FileStore` event channel with the `Bubble Tea` event loop to enable real-time UI updates.

## 1. References & Context
*   **PRD**: [Reactivity](../PRD.md#34-data-layer--persistence)
*   **Patterns**:
    *   **Channel Command**: A `tea.Cmd` that blocks on a channel receive and returns a `tea.Msg`.
    *   **Recursive Command**: The command must return itself to keep the loop alive.

## 2. Detailed Steps

### A. Define Messages (`internal/tui/messages.go`)
Define the message that carries the update payload.

```go
package tui

import "github.com/rtfa/kevin/internal/store"

// TaskUpdateMsg is sent when a file changes on disk.
type TaskUpdateMsg store.TaskUpdateEvent
```

### B. Implement Subscription Command (`internal/tui/commands.go`)
This function creates a `tea.Cmd` that listens to the store.

```go
func waitForActivity(sub <-chan store.TaskUpdateEvent) tea.Cmd {
    return func() tea.Msg {
        event, ok := <-sub
        if !ok {
             return nil // Channel closed
        }
        return TaskUpdateMsg(event)
    }
}
```

### C. Integrating into Model (`internal/tui/model.go`)
1.  **Init**: Start the listener.
2.  **Update**: Handle the message AND restart the listener.

```go
func (m Model) Init() tea.Cmd {
    // Start watching immediately
    return waitForActivity(m.store.Watch())
}

func (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    switch msg := msg.(type) {
    
    case TaskUpdateMsg:
        // 1. Reload data
        tasks, _ := m.store.List()
        m.columns = distributeTasks(tasks)
        
        // 2. Re-subscribe (Critical!)
        return m, waitForActivity(m.store.Watch())
    }
    return m, nil
}
```

## 3. Success Criteria
- [ ] `waitForActivity` command implemented.
- [ ] `Init()` triggers the first watch.
- [ ] `Update()` handles `TaskUpdateMsg` and returns `waitForActivity` again.
- [ ] Application does not deadlock on exit (channel close handling).
- [ ] TUI updates automatically when a file is `touch`ed in another terminal.
