# 3.3. Execution CLI (`cmd/kevin/run.go`)

**Goal**: Implement the `kevin run` command which acts as the orchestrator: looking up the task, configuring the agent, invoking the executor, and streaming results.

## 1. References & Context
*   **PRD**: [Execution Lifecycle](../PRD.md#33-agent-orchestration)
*   **Libraries**:
    *   `os/signal`: For handling Ctrl+C.
    *   `schollz/closestmatch` (optional) or simple substring match for finding tasks.
*   **Concepts**:
    *   **Graceful Shutdown**: Propagate context cancellation to the Executor to stop containers/processes.
    *   **Real-time Streaming**: Pipe `Executor` stdout/stderr directly to `os.Stdout`/`os.Stderr`.

## 2. Detailed Steps

### A. Run Command Logic
1.  **Signal Handling**: Create a context that acts as the "Main Loop" lifecycle.
    ```go
    ctx, stop := signal.NotifyContext(context.Background(), os.Interrupt)
    defer stop()
    ```

2.  **Task Lookup**:
    *   Input: `kevin run <input>`
    *   Logic:
        *   If `<input>` matches a file ID exactly, use it.
        *   Else, fuzzy search titles in `.kevin/board`.
        *   If multiple matches, error or prompt (MVP: Error if ambiguous).

3.  **Agent Resolution**:
    *   Check `task.Assignee`.
    *   Look up `AgentConfig` in `ProjectConfig`.
    *   If no assignee, default to "default" agent.

4.  **Preparation**:
    *   Call `agent.Prepare(config, task, projectDir)` (from Task 3.2).
    *   Get `cmdSlice` and `envSlice`.

### B. Execution & Streaming
Invoke the `Executor` (from Task 3.1) with the signal-aware context.

```go
// In run.go
func runTask(cmd *cobra.Command, args []string) error {
    // ... setup ctx, task, agent ...

    executor := executor.NewDockerExecutor() // Or Local based on config
    
    // The Executor.Run method handles the wiring to os.Stdout
    err := executor.Run(ctx, cmdSlice, envSlice, taskDir)
    
    if err != nil {
        if errors.Is(err, context.Canceled) {
            fmt.Println("\nCancelled by user.")
            return nil
        }
        return fmt.Errorf("agent execution failed: %w", err)
    }
    
    return nil
}
```

## 3. Success Criteria
- [ ] `kevin run` accepts a task ID/Title.
- [ ] Fuzzy matching identifies the correct task file.
- [ ] Stdout flows in real-time (e.g., `kevin run` shows `npm install` progress).
- [ ] Pressing `Ctrl+C` sends context cancellation.
- [ ] Docker container (if used) is stopped/removed on cancellation.
